name: Deploy to Production

on:
  workflow_run:
    workflows: ["Docker Build & Publish"]
    types:
      - completed
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Navigate to app directory
            cd /opt/mango-deliveries || exit 1
            
            # Pull latest changes (for docker-compose.yml updates)
            git pull origin master
            
            # Login to GHCR (if image is private)
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull new images
            docker compose pull
            
            # Restart services
            docker compose up -d --remove-orphans
            
            # Prune old images to save space
            docker image prune -f
